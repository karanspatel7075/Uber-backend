<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8" />
    <title>Rider Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body class="bg-gray-100 flex flex-col h-screen">

<header class="bg-blue-600 text-white text-center py-4 text-xl font-semibold shadow-md">
    Rider-Driver Chat
</header>

<div class="flex-1 flex flex-col justify-between max-w-3xl mx-auto w-full bg-white shadow-lg mt-6 rounded-2xl border border-gray-200">

    <div id="chat-box" class="flex-1 p-4 overflow-y-auto space-y-2">
    </div>

    <div class="border-t border-gray-200 p-4 flex items-center">
        <input id="messageInput"
               type="text"
               placeholder="Type a message..."
               class="flex-1 border border-gray-300 rounded-xl px-4 py-2 focus:outline-none focus:ring focus:ring-blue-400">
        <button onclick="sendMessage()"
                class="ml-2 bg-blue-600 text-white px-4 py-2 rounded-xl hover:bg-blue-700 transition">
            Send
        </button>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    let stompClient = null;

    // 1. Define Variables (Robust Thymeleaf Text Inlining)
    const riderEmail = [[${riderEmail}]];
    const driverEmail = [[${driverEmail}]];
    const sessionJwt = [[${session.jwtToken}]];

    // Set the sender for this page
    const sender = riderEmail;

    if (!driverEmail || !sender || !sessionJwt) {
        console.error("‚ùå Thymeleaf variables missing/null:", {riderEmail, driverEmail, sessionJwt});
    }

    // 2. Connection Function
    function connect() {
        const socket = new SockJS('/ws?token=' + sessionJwt);
        stompClient = Stomp.over(socket);

        stompClient.connect({}, (frame) => {
            console.log("‚úÖ WebSocket Connected as Rider:", sender);

            // Subscribe to private queue: /user/queue/messages

            stompClient.subscribe("/user/queue/messages", (message) => {
    // Inject these two lines temporarily for debugging:
    console.log("--- RECEIVED MESSAGE ---");
    console.log("RAW BODY:", message.body);

    try {
        const msg = JSON.parse(message.body);
        console.log("PARSED OBJECT:", msg);

        // This is the line that handles display
        showMessage(
            msg.content,
            msg.sender === riderEmail ? 'outgoing' : 'incoming'
        );

    } catch (e) {
        // This will tell you if the JSON parsing is failing
        console.error("‚ùå FAILED TO PARSE MESSAGE JSON:", e);
    }
});
        }, (error) => {
            console.error("‚ùå WebSocket Connection Error:", error);
            console.log("üîÑ Reconnecting in 3 seconds...");
            setTimeout(connect, 3000);
        });
    }

    // 3. Send Chat Message
    function sendMessage() {
        const messageInput = document.getElementById("messageInput");
        const content = messageInput.value.trim();

        if (content && stompClient) {
            const chatMessage = {
                sender: sender,          // Rider's email
                recipient: driverEmail,  // Driver's email
                content: content,
            };

            stompClient.send("/app/chat", {}, JSON.stringify(chatMessage));
            showMessage(content, 'outgoing');
            messageInput.value = "";
        }
    }

    // 4. Display Messages (Consistent UI)
    function showMessage(text, type) {
        const chatBox = document.getElementById("chat-box");
        const messageDiv = document.createElement("div");

        if (type === 'outgoing') {
            messageDiv.className = "text-right mb-1";
            messageDiv.innerHTML =
                `<span class='inline-block bg-blue-600 text-white px-4 py-2 rounded-2xl max-w-xs break-words'>${text}</span>`;
        } else {
            messageDiv.className = "text-left mb-1";
            messageDiv.innerHTML =
                `<span class='inline-block bg-gray-200 text-gray-900 px-4 py-2 rounded-2xl max-w-xs break-words'>${text}</span>`;
        }

        chatBox.appendChild(messageDiv);
        chatBox.scrollTop = chatBox.scrollHeight;
    }

    // 5. Auto-connect and Enter key handler
    document.addEventListener("DOMContentLoaded", () => {
        connect();
        const input = document.getElementById("messageInput");
        input.addEventListener("keydown", function (e) {
            if (e.key === "Enter") {
                e.preventDefault();
                sendMessage();
            }
        });
    });
    /*]]>*/
</script>

</body>
</html>